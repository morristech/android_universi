<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>UniversiFragment.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">debugAndroidTest</a> &gt; <a href="index.source.html" class="el_package">universum.studios.android.universi</a> &gt; <span class="el_source">UniversiFragment.java</span></div><h1>UniversiFragment.java</h1><pre class="source lang-java linenums">/*
 * =================================================================================================
 *                             Copyright (C) 2017 Universum Studios
 * =================================================================================================
 *         Licensed under the Apache License, Version 2.0 or later (further &quot;License&quot; only).
 * -------------------------------------------------------------------------------------------------
 * You may use this file only in compliance with the License. More details and copy of this License 
 * you may obtain at
 * 
 * 		http://www.apache.org/licenses/LICENSE-2.0
 * 
 * You can redistribute, modify or publish any part of the code written within this file but as it 
 * is described in the License, the software distributed under the License is distributed on an 
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES or CONDITIONS OF ANY KIND.
 * 
 * See the License for the specific language governing permissions and limitations under the License.
 * =================================================================================================
 */
package universum.studios.android.universi;

import android.content.Context;
import android.net.ConnectivityManager;
import android.net.NetworkInfo;
import android.os.Build;
import android.os.Bundle;
import android.os.Looper;
import android.support.annotation.CheckResult;
import android.support.annotation.IntRange;
import android.support.annotation.NonNull;
import android.support.annotation.Nullable;
import android.support.annotation.UiThread;
import android.support.annotation.VisibleForTesting;
import android.support.annotation.XmlRes;
import android.support.v4.app.ActivityCompat;
import android.view.View;

import universum.studios.android.dialog.DialogOptions;
import universum.studios.android.dialog.manage.DialogController;
import universum.studios.android.dialog.manage.DialogFactory;
import universum.studios.android.dialog.manage.DialogXmlFactory;
import universum.studios.android.fragment.ActionBarFragment;

/**
 * An {@link ActionBarFragment} implementation that provides &lt;b&gt;Universi context&lt;/b&gt; features via
 * {@link UniversiFragmentDelegate} including other features described below.
 *
 * &lt;h3&gt;1) Data binding&lt;/h3&gt;
 * Whether it is used data binding provided by &lt;a href=&quot;http://developer.android.com/tools/data-binding/guide.html&quot;&gt;Google&lt;/a&gt;
 * to bind application logic and layouts or some custom data binding logic, this fragment class provides
 * a simple way to manage data binding requests and to perform actual binding. Whether a new data need
 * to be bound to a view hierarchy of a specific instance of UniversiFragment, {@link #requestBindData()}
 * need to be called. &lt;b&gt;This method can be invoked from any thread.&lt;/b&gt; If data binding request has
 * been registered, UniversiFragment will invoke {@link #onBindData()} method whenever its view
 * hierarchy is already created or waits until it is created.
 *
 * &lt;h3&gt;1) Permissions&lt;/h3&gt;
 * This fragment class has support for a new permissions management model introduced in the
 * {@link Build.VERSION_CODES#M Marshmallow} Android version. Permissions related methods like
 * {@link #checkSelfPermission(String)} or {@link #supportRequestPermissions(String[], int)} can be
 * invoked regardless of current Android version.
 *
 * @author Martin Albedinsky
 */
<span class="fc" id="L64">public abstract class UniversiFragment extends ActionBarFragment {</span>

	/*
	 * Constants ===================================================================================
	 */

	/**
	 * Log TAG.
	 */
	// private static final String TAG = &quot;UniversiFragment&quot;;

	/*
	 * Interface ===================================================================================
	 */

	/*
	 * Static members ==============================================================================
	 */

	/*
	 * Members =====================================================================================
	 */

	/**
	 * Runnable that calls {@link #requestBindDataInner()} method.
	 */
<span class="fc" id="L90">	@VisibleForTesting final Runnable REQUEST_BIND_DATA_INNER = new Runnable() {</span>

		/**
		 */
		@Override
		public void run() {
<span class="fc" id="L96">			requestBindDataInner();</span>
<span class="fc" id="L97">		}</span>
	};

	/**
	 * Delegate that is used to handle requests specific for the Universi context made upon this
	 * fragment like showing and dismissing of dialogs.
	 */
	private UniversiContextDelegate mContextDelegate;

	/*
	 * Constructors ================================================================================
	 */

	/*
	 * Methods =====================================================================================
	 */

	/**
	 * Sets a context delegate to be used by this fragment.
	 *
	 * @param delegate The delegate only for testing purpose.
	 */
	@VisibleForTesting void setContextDelegate(final UniversiContextDelegate delegate) {
<span class="fc" id="L120">		this.mContextDelegate = delegate;</span>
<span class="fc" id="L121">	}</span>

	/**
	 * Ensures that the context delegate is initialized for this fragment.
	 */
	private void ensureContextDelegate() {
<span class="fc bfc" id="L127" title="All 2 branches covered.">		if (mContextDelegate == null) this.mContextDelegate = UniversiContextDelegate.create(this);</span>
<span class="fc" id="L128">	}</span>

	/**
	 * Sets a controller that should be used to show and dismiss dialogs within context of this fragment.
	 *
	 * @param controller The desired controller. May be {@code null} to use the default one.
	 * @see #getDialogController()
	 */
	protected void setDialogController(@Nullable DialogController controller) {
<span class="fc" id="L137">		this.ensureContextDelegate();</span>
<span class="fc" id="L138">		mContextDelegate.setDialogController(controller);</span>
<span class="fc" id="L139">	}</span>

	/**
	 * Returns the controller that can be used to show and dismiss dialogs within context of this
	 * fragment.
	 * &lt;p&gt;
	 * If not specified, instance of {@link DialogController} is instantiated by default.
	 *
	 * @return The dialog controller of this fragment.
	 * @see #setDialogController(DialogController)
	 */
	@NonNull
	protected DialogController getDialogController() {
<span class="fc" id="L152">		this.ensureContextDelegate();</span>
<span class="fc" id="L153">		return mContextDelegate.getDialogController();</span>
	}

	/**
	 * Specifies a factory that should provide dialog instances that can be parsed from an Xml file
	 * with the specified &lt;var&gt;xmlDialogsSet&lt;/var&gt; for {@link DialogController} of this fragment.
	 *
	 * @param xmlDialogsSet Resource id of the desired Xml file containing Xml dialogs that the
	 *                      factory should provide for this fragment. May be {@code 0} to remove the
	 *                      current one.
	 */
	protected void setDialogXmlFactory(@XmlRes final int xmlDialogsSet) {
<span class="fc" id="L165">		this.ensureContextDelegate();</span>
<span class="fc" id="L166">		mContextDelegate.setDialogXmlFactory(xmlDialogsSet);</span>
<span class="fc" id="L167">	}</span>

	/**
	 * Specifies a factory that should provide dialog instances for {@link DialogController} of
	 * this fragment to show.
	 *
	 * @param factory The desired factory. May be {@code null} to remove the current one.
	 * @see #getDialogFactory()
	 * @see #showDialogWithId(int)
	 * @see #showDialogWithId(int, DialogOptions)
	 */
	protected void setDialogFactory(@Nullable final DialogFactory factory) {
<span class="fc" id="L179">		this.ensureContextDelegate();</span>
<span class="fc" id="L180">		mContextDelegate.setDialogFactory(factory);</span>
<span class="fc" id="L181">	}</span>

	/**
	 * Returns the current dialog factory specified for this fragment.
	 *
	 * @return Dialog factory or {@code null} if no factory has been specified yet.
	 * @see #setDialogFactory(DialogFactory)
	 */
	@Nullable
	protected DialogFactory getDialogFactory() {
<span class="fc" id="L191">		this.ensureContextDelegate();</span>
<span class="fc" id="L192">		return mContextDelegate.getDialogFactory();</span>
	}

	/**
	 */
	@Override
	public void onViewCreated(@NonNull final View view, @Nullable final Bundle savedInstanceState) {
<span class="fc" id="L199">		super.onViewCreated(view, savedInstanceState);</span>
<span class="fc" id="L200">		this.ensureContextDelegate();</span>
<span class="fc" id="L201">		mContextDelegate.setViewCreated(true);</span>
<span class="fc" id="L202">		onBindViews(view, savedInstanceState);</span>
		// Check if there was requested data binding before view creation, if it was, perform binding now.
<span class="fc bfc" id="L204" title="All 2 branches covered.">		if (mContextDelegate.isRequestRegistered(UniversiContextDelegate.REQUEST_BIND_DATA)) {</span>
<span class="fc" id="L205">			mContextDelegate.unregisterRequest(UniversiContextDelegate.REQUEST_BIND_DATA);</span>
<span class="fc" id="L206">			onBindData();</span>
		}
<span class="fc" id="L208">	}</span>

	/**
	 * Invoked from {@link #onViewCreated(View, Bundle)} to bind all views presented within context
	 * of this fragment.
	 *
	 * @param rootView The root view of this fragment.
	 */
	protected void onBindViews(@NonNull final View rootView, @Nullable final Bundle savedInstanceState) {
		// Inheritance hierarchies may perform here views binding/injection.
<span class="fc" id="L218">	}</span>

	/**
	 */
	@Override
	public void onResume() {
<span class="fc" id="L224">		super.onResume();</span>
<span class="fc" id="L225">		this.ensureContextDelegate();</span>
<span class="fc" id="L226">		mContextDelegate.setPaused(false);</span>
<span class="fc" id="L227">	}</span>

	/**
	 * Requests performing of data binding specific for this fragment via {@link #onBindData()}.
	 * If this fragment has its view hierarchy already created {@link #onBindData()} will be invoked
	 * immediately, otherwise will wait until {@link #onViewCreated(View, Bundle)} is invoked.
	 * &lt;p&gt;
	 * &lt;b&gt;This method may be invoked also from a background-thread&lt;/b&gt;.
	 */
	protected void requestBindData() {
		// Check whether this call has been made on the UI thread, if not post on the UI thread the request runnable.
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">		if (Looper.getMainLooper().equals(Looper.myLooper())) {</span>
<span class="fc" id="L239">			this.requestBindDataInner();</span>
		} else {
<span class="nc" id="L241">			runOnUiThread(REQUEST_BIND_DATA_INNER);</span>
		}
<span class="fc" id="L243">	}</span>

	/**
	 * Performs data binding of this fragment. Will invoke {@link #onBindData()} if view hierarchy of
	 * this fragment is already created, otherwise will register a binding request via {@link UniversiContextDelegate#registerRequest(int)}.
	 */
	final void requestBindDataInner() {
<span class="fc" id="L250">		this.ensureContextDelegate();</span>
<span class="fc bfc" id="L251" title="All 2 branches covered.">		if (mContextDelegate.isViewCreated()) {</span>
<span class="fc" id="L252">			onBindData();</span>
<span class="fc" id="L253">			return;</span>
		}
<span class="fc" id="L255">		mContextDelegate.registerRequest(UniversiContextDelegate.REQUEST_BIND_DATA);</span>
<span class="fc" id="L256">	}</span>

	/**
	 * Invoked due to call to {@link #requestBindData()} to perform data binding specific for this
	 * fragment instance.
	 * &lt;p&gt;
	 * &lt;b&gt;This is always invoked on the UI thread.&lt;/b&gt;
	 */
	@UiThread
	protected void onBindData() {
		// Inheritance hierarchies may perform theirs specific data binding logic here.
<span class="fc" id="L267">	}</span>

	/**
	 * Checks whether the current active network is at this time connected or not.
	 *
	 * @return {@code True} if active network is connected, {@code false} otherwise.
	 * @see ConnectivityManager#getActiveNetworkInfo()
	 * @see NetworkInfo#isConnected()
	 * @see #isNetworkConnected(int)
	 */
	@CheckResult
	protected boolean isActiveNetworkConnected() {
<span class="fc" id="L279">		this.ensureContextDelegate();</span>
<span class="fc" id="L280">		return mContextDelegate.isActiveNetworkConnected();</span>
	}

	/**
	 * Checks whether a network with the specified &lt;var&gt;networkType&lt;/var&gt; is at this time connected
	 * or no.
	 *
	 * @param networkType The desired network type to check for connection.
	 * @return {@code True} if the requested network is connected, {@code false} otherwise.
	 * @see ConnectivityManager#getNetworkInfo(int)
	 * @see NetworkInfo#isConnected()
	 */
	@CheckResult
	protected boolean isNetworkConnected(final int networkType) {
<span class="fc" id="L294">		this.ensureContextDelegate();</span>
<span class="fc" id="L295">		return mContextDelegate.isNetworkConnected(networkType);</span>
	}

	/**
	 * Delegated call to {@link ActivityCompat#checkSelfPermission(Context, String)}.
	 *
	 * @param permission The desired permission for which to perform check.
	 * @return {@link android.content.pm.PackageManager#PERMISSION_GRANTED} if you have the
	 * permission, or {@link android.content.pm.PackageManager#PERMISSION_DENIED} if not.
	 */
	@CheckResult
	protected int checkSelfPermission(@NonNull final String permission) {
<span class="nc" id="L307">		return ActivityCompat.checkSelfPermission(getActivity(), permission);</span>
	}

	/**
	 */
	@Override
	@CheckResult
	public boolean shouldShowRequestPermissionRationale(@NonNull final String permission) {
<span class="pc bpc" id="L315" title="2 of 4 branches missed.">		return Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M &amp;&amp; super.shouldShowRequestPermissionRationale(permission);</span>
	}

	/**
	 * Invokes {@link #requestPermissions(String[], int)} on Android versions above {@link Build.VERSION_CODES#M Marshmallow}
	 * (including).
	 * &lt;p&gt;
	 * Calling this method on Android versions before &lt;b&gt;MARSHMALLOW&lt;/b&gt; will be ignored.
	 *
	 * @param permissions The desired set of permissions to request.
	 * @param requestCode Code to identify this request in {@link #onRequestPermissionsResult(int, String[], int[])}.
	 */
	protected void supportRequestPermissions(@NonNull final String[] permissions, final int requestCode) {
<span class="nc bnc" id="L328" title="All 2 branches missed.">		if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M)</span>
<span class="nc" id="L329">			requestPermissions(permissions, requestCode);</span>
<span class="nc" id="L330">	}</span>

	/**
	 */
	@Override
	public void onRequestPermissionsResult(final int requestCode, @NonNull final String[] permissions, @NonNull final int[] grantResults) {
<span class="fc" id="L336">		super.onRequestPermissionsResult(requestCode, permissions, grantResults);</span>
<span class="fc" id="L337">	}</span>

	/**
	 * Same as {@link #showDialogWithId(int, DialogOptions)} with {@code null} options.
	 */
	protected boolean showDialogWithId(@IntRange(from = 0) final int dialogId) {
<span class="fc" id="L343">		return showDialogWithId(dialogId, null);</span>
	}

	/**
	 * Shows a dialog that is provided by the current dialog factory under the specified &lt;var&gt;dialogId&lt;/var&gt;.
	 *
	 * @param dialogId Id of the desired dialog to show.
	 * @param options  Options for the dialog.
	 * @return {@code True} if dialog has been shown, {@code false} if this fragment is currently
	 * &lt;b&gt;paused&lt;/b&gt; or does not have its dialog factory specified.
	 * @see DialogController#newRequest(int)
	 * @see #setDialogFactory(DialogFactory)
	 * @see #dismissDialogWithId(int)
	 */
	protected boolean showDialogWithId(@IntRange(from = 0) final int dialogId, @Nullable final DialogOptions options) {
<span class="fc" id="L358">		this.ensureContextDelegate();</span>
<span class="fc" id="L359">		return mContextDelegate.showDialogWithId(dialogId, options);</span>
	}

	/**
	 * Dismisses a dialog that is provided by the current dialog factory under the specified &lt;var&gt;dialogId&lt;/var&gt;.
	 *
	 * @param dialogId Id of the desired dialog to dismiss.
	 * @return {@code True} if dialog has been dismissed, {@code false} if this fragment is currently
	 * &lt;b&gt;paused&lt;/b&gt; or does not have its dialog factory specified.
	 * @see DialogController#newRequest(int)
	 * @see #showDialogWithId(int, DialogOptions)
	 */
	protected boolean dismissDialogWithId(@IntRange(from = 0) final int dialogId) {
<span class="fc" id="L372">		this.ensureContextDelegate();</span>
<span class="fc" id="L373">		return mContextDelegate.dismissDialogWithId(dialogId);</span>
	}

	/**
	 * Same as {@link #showXmlDialog(int, DialogOptions)} with {@code null} options.
	 */
	protected boolean showXmlDialog(@XmlRes final int resId) {
<span class="fc" id="L380">		return showXmlDialog(resId, null);</span>
	}

	/**
	 * Like {@link #showDialogWithId(int, DialogOptions)}, but in this case will be used internal
	 * instance of {@link DialogXmlFactory} to create (inflate) the desired dialog instance to be
	 * shown.
	 *
	 * @param resId   Resource id of Xml file containing the desired dialog (its specification) to show.
	 * @param options Options for the dialog.
	 * @return {@code True} if dialog has been successfully inflated and shown, {@code false} if
	 * this fragment is currently &lt;b&gt;paused&lt;/b&gt; or dialog failed to be inflated.
	 * @see DialogXmlFactory#createDialog(int, DialogOptions)
	 * @see #dismissXmlDialog(int)
	 */
	protected boolean showXmlDialog(@XmlRes final int resId, @Nullable final DialogOptions options) {
<span class="fc" id="L396">		this.ensureContextDelegate();</span>
<span class="fc" id="L397">		return mContextDelegate.showXmlDialog(resId, options);</span>
	}

	/**
	 * Dismisses an Xml dialog that has been shown via {@link #showXmlDialog(int, DialogOptions)}.
	 *
	 * @param resId Resource id of Xml file containing the desired dialog (its specification) to dismiss.
	 * @return {@code True} if dialog has been dismissed, {@code false} if this fragment is currently
	 * &lt;b&gt;paused&lt;/b&gt;.
	 * @see #showXmlDialog(int, DialogOptions)
	 */
	protected boolean dismissXmlDialog(@XmlRes final int resId) {
<span class="fc" id="L409">		this.ensureContextDelegate();</span>
<span class="fc" id="L410">		return mContextDelegate.dismissXmlDialog(resId);</span>
	}

	/**
	 */
	@Override
	public void onPause() {
<span class="fc" id="L417">		super.onPause();</span>
<span class="fc" id="L418">		this.ensureContextDelegate();</span>
<span class="fc" id="L419">		mContextDelegate.setPaused(true);</span>
<span class="fc" id="L420">	}</span>

	/**
	 */
	@Override
	public void onDestroyView() {
<span class="fc" id="L426">		super.onDestroyView();</span>
<span class="fc bfc" id="L427" title="All 2 branches covered.">		if (mContextDelegate != null) mContextDelegate.setViewCreated(false);</span>
<span class="fc" id="L428">	}</span>

	/*
	 * Inner classes ===============================================================================
	 */
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span>Generated by the Android Gradle plugin 2.3.2</div></body></html>